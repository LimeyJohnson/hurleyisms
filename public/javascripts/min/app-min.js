$(document).ready(function(){function e(){var e=$("section.submit textarea"),n=e.attr("maxlength"),t=e.val().length,i=n-t,a=1>i;$("section.submit .char-remaining").text(i),$("section.submit label[for=the-line] .form-control__label-hint").toggleClass("error",a)}function n(e){$.getJSON("app/data/"+Q+"/"+L,function(n){J=n,e()})}function t(e,n){$.post("app/add",e,function(e){n()})}function i(e,n,t){$.getJSON("app/rate/"+e+"/"+n,function(e){t()})}function a(e){var n=$("section."+e);n.hasClass("active")||($("section.active").removeClass("active"),n.addClass("active"))}function c(){return $("body").hasClass("is-logged-in")}function o(){var e=$("section.submit");e.find("input, textarea").removeAttr("disabled"),e.find(".btn--green").removeAttr("disabled"),e.find(".switch").removeClass("disabled")}function s(){var e=$("section.submit");e.find("input, textarea").attr("disabled",!0),e.find(".btn--green").attr("disabled",!0),e.find(".switch").addClass("disabled")}function l(e){var n={};n.line=$("#the-line").val(),n.men=$("#audience-men").is(":checked"),n.women=$("#audience-women").is(":checked"),n.kids=$("#audience-kids").is(":checked"),n.profanity=$("#switch-pg").hasClass("active"),n.author=$("#your-name").val(),t(n,e)}function r(){$("#the-line").val(""),u($("body"))}function u(e){$("html, body").animate({scrollTop:e.offset().top},250)}function d(){f(),h(),y(),T()}function f(){var e;Q===P.MEN&&(e="men"),Q===P.WOMEN&&(e="women"),Q===P.KIDS&&(e="kids"),$("span.audience").text(e)}function h(){var e=m();C(e)}function m(){for(var e=p()?1:5,n=[],t=[],i=!1,a=$("main .line").first(),c=0;e>c&&c<J.length;c++){for(var o;;)if(o=v(),b(o._id,t)){t.push(o._id),n.push(o);break}if(0===a.length&&(a=_()),g(o,a),i=k(a))break;a=a.next()}return n}function p(){return window.matchMedia("(max-width: 568px)").matches}function v(){var e=Math.floor(Math.random()*J.length);return J[e]}function b(e,n){return-1===n.indexOf(e)}function _(){return $("#lines .line:last-child").clone().appendTo("#lines")}function g(e,n){n.find(".line__text").html(e.line),n.find(".line__byline .author").text(e.author),n.attr("name",e._id)}function k(e){return x(e)?(p()?w(e):e.remove(),!0):!1}function x(e){var n=e[0].getBoundingClientRect(),t=$(".lines__footer").height()+$("#progress-bar").height(),i=window.innerHeight-t;return n.bottom>i}function w(e){for(var n=e.children(".line__text").css("font-size"),t=parseInt(n,10);x(e);)t-=2,e.children(".line__text").css("font-size",t)}function C(e){Y=e.map(function(e){return e.line.length}).reduce(function(e,n){return e+n})}function y(){U=$("input[type=range]").val()}function T(){V=requestAnimationFrame(N)}function A(){cancelAnimationFrame(V),X=null}function M(){A(),X=null,G.width(0)}function N(e){var n=I(e);n>100&&(n=0,O());var t=n+"%";G.css("width",t),X=e,T()}function I(e){X||(X=e);var n=e-X,t=G.width()/j.width()*100,i=p()?.5:1,a=i*U*n/Y;return t+a}function O(){W(),E(),h(),u($("body"))}function W(){$(".thumbs-up.active, .thumbs-down.active").removeClass("active")}function E(){$("#lines .line__text").removeAttr("style")}function S(e){if(!D())return!1;var n=!!X,t=$(".line__textarea");t.length&&q(),B(),R=e.html();var i=e.outerHeight();e.replaceWith("<textarea class='line__textarea' spellcheck='true' style='height: "+i+"px;'>"+R+"</textarea>"),$(".line__textarea").data("prog-bar-running",n).focus()}function D(){return $("body").hasClass("is-admin")}function F(){K();var e=$(".line__textarea");e.replaceWith("<p class='line__text'>"+e.val()+"</p>"),$.createToast("Changes saved!")}function K(){var e=$(".line__textarea").data("prog-bar-running");e&&H()}function q(){K(),$(".line__textarea").replaceWith("<p class='line__text'>"+R+"</p>")}function z(){M(),G.width(0),O(),$(".pause").hasClass("is-paused")||T()}function B(){$(".pause").addClass("is-paused"),A()}function H(){$(".pause").removeClass("is-paused"),T()}var J=[],L=!1,P={MEN:0,WOMEN:1,KIDS:2},R,j=$("#progress-bar"),G=$("#progress-bar__fill"),Q,U,V,X,Y;e(),$("a.begin-session").click(function(){Q=Number($(this).attr("data-audience-type")),n(function(){a("lines"),d()})}),$(".switch").click(function(){$(this).toggleClass("active"),L=$(this).hasClass("active")}),$(".btn.add-line").click(function(){a("submit"),c()?o():s()}),$(document).keyup(function(e){76===e.keyCode&&(c()?o():s())}),$("section.submit a.close").click(function(){a("splash")}),$("section.submit textarea").keyup(function(){e()}),$("section.submit .add-line").click(function(){$(".error").remove();var e=" <span class='error'>Required</span>";if(""===$("#the-line").val()&&$("label[for=the-line]").append(e),0===$(".checkbox-list input:checked").length&&$(".form-control--audience .form-control__label").append(e),0===$(".error").length)l(function(){$.createToast("Line submitted!"),r()});else{var n=$(".error").first();u(n)}}),$(document).on("click",".line__text",function(){S($(this))}),$(document).keyup(function(e){65!==e.which||$(e.target).isTextField()||$("body").toggleClass("is-admin")}),$(document).on("click",".line__delete",function(){var e=$(this).closest(".line").attr("name");$("#delete-line-modal").data("line",e),B()}),$("#delete-line-modal, #delete-line-modal .modal__close, #delete-line-modal .btn--red").click(function(){H()}),$("#delete-line-modal .btn--red").click(function(){var e=$("#delete-line-modal").data("line");$.createToast("Line deleted",null,"toast--red"),$(".line[name="+e+"]").remove()}),$(document).on("keydown",".line__textarea",function(e){13===e.which&&e.metaKey&&F()}),$(document).on("click",".line__save-change",function(){F()}),$(document).on("keydown",".line__textarea",function(e){27===e.which&&q()}),$(document).on("click",".line__cancel-change",function(){q()}),$(window).on("swipeleft",function(){z()}),$("section.lines a.close").click(function(){a("splash"),M(),$(".pause").removeClass("is-paused")}),$(document).on("click",".thumbs-up, .thumbs-down",function(){var e=$(this).parents(".line").attr("name"),n=$(this).hasClass("thumbs-up"),t=$(this);i(e,n,function(){t.toggleClass("active"),t.hasClass("active")&&t.siblings(".btn.active").removeClass("active")})}),$("input[type=range]").change(function(){U=$(this).val()}),$(".pause").click(function(){$(this).hasClass("is-paused")?H():B()}),$(".next").click(function(){z()})}),$("#admin-table .btn:first-child").click(function(){$(this).toggleClass("active"),$(this).hasClass("active")?$(this).text("Approved"):$(this).text("Approve")}),$("#admin-table .btn:last-child").click(function(){window.confirm("Delete this line?  This cannot be undone.")}),$("#admin-table .ban-ip").click(function(){window.confirm("Ban this IP?  This will also delete all this IP's lines, and cannot be undone.")});