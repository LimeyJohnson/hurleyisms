$(document).ready(function(){function n(){var n=$("section.submit textarea"),t=n.attr("maxlength"),e=n.val().length,i=t-e,a=1>i;$("section.submit .char-remaining").text(i),$("section.submit label[for=the-line] .form-control__label-hint").toggleClass("error",a)}function t(n){$.getJSON("/data/"+K+"/"+z,function(t){q=t,n()})}function e(n,t){$.post("/add",n,function(n){t()})}function i(n,t,e){$.getJSON("/rate/"+n+"/"+t,function(n){e()})}function a(n){var t=$("section."+n);t.hasClass("active")||($("section.active").removeClass("active"),t.addClass("active"))}function s(){return $("body").hasClass("is-logged-in")}function o(){var n=$("section.submit");n.find("input, textarea").removeAttr("disabled"),n.find(".btn--green").removeAttr("disabled"),n.find(".switch").removeClass("disabled")}function c(){var n=$("section.submit");n.find("input, textarea").attr("disabled",!0),n.find(".btn--green").attr("disabled",!0),n.find(".switch").addClass("disabled")}function l(n){var t={};t.line=$("#the-line").val(),t.men=$("#audience-men").is(":checked"),t.women=$("#audience-women").is(":checked"),t.kids=$("#audience-kids").is(":checked"),t.profanity=$("#switch-pg").hasClass("active"),t.author=$("#your-name").val(),e(t,n)}function r(){$(".line-added").addClass("fade-in"),$("#the-line").val(""),u($("body"))}function u(n){$("html, body").animate({scrollTop:n.offset().top},250)}function d(){f(),h(),y(),A()}function f(){var n;K===B.MEN&&(n="men"),K===B.WOMEN&&(n="women"),K===B.KIDS&&(n="kids"),$("span.audience").text(n)}function h(){var n=m();x(n)}function m(){for(var n=v()?1:5,t=[],e=[],i=!1,a=$("main .line").first(),s=0;n>s&&s<q.length;s++){for(var o;;)if(o=b(),p(o._id,e)){e.push(o._id),t.push(o);break}if(0===a.length&&(a=g()),w(o,a),i=k(a))break;a=a.next()}return t}function v(){return window.matchMedia("(max-width: 568px)").matches}function b(){var n=Math.floor(Math.random()*q.length);return q[n]}function p(n,t){return-1===t.indexOf(n)}function g(){return $("#lines .line:last-child").clone().appendTo("#lines")}function w(n,t){t.find(".line__text").html(n.line),t.find(".line__byline .author").text(n.author),t.attr("name",n._id)}function k(n){return C(n)?(v()?_(n):n.remove(),!0):!1}function C(n){var t=n[0].getBoundingClientRect(),e=$(".lines__footer").height()+$("#progress-bar").height(),i=window.innerHeight-e;return t.bottom>i}function _(n){for(var t=n.children(".line__text").css("font-size"),e=parseInt(t,10);C(n);)e-=2,n.children(".line__text").css("font-size",e)}function x(n){H=n.map(function(n){return n.line.length}).reduce(function(n,t){return n+t})}function y(){P=$("input[type=range]").val()}function A(){R=requestAnimationFrame(E)}function M(){cancelAnimationFrame(R)}function N(){M(),W=null,J.width(0)}function E(n){var t=I(n);t>100&&(t=0,O());var e=t+"%";J.css("width",e),W=n,A()}function I(n){W||(W=n);var t=n-W,e=J.width()/F.width()*100,i=v()?.5:1,a=i*P*t/H;return e+a}function O(){S(),T(),h(),u($("body"))}function S(){$(".thumbs-up.active, .thumbs-down.active").removeClass("active")}function T(){$("#lines .line__text").removeAttr("style")}function D(){N(),J.width(0),O(),$(".pause").hasClass("is-paused")||A()}var q=[],z=!1,B={MEN:0,WOMEN:1,KIDS:2},F=$("#progress-bar"),J=$("#progress-bar__fill"),K,P,R,W,H;n(),$("a.begin-session").click(function(){K=Number($(this).attr("data-audience-type")),t(function(){a("lines"),d()})}),$(".switch").click(function(){$(this).toggleClass("active"),z=$(this).hasClass("active")}),$(".btn.add-line").click(function(){a("submit"),s()?o():c()}),$(document).keyup(function(n){76===n.keyCode&&(s()?o():c())}),$("section.submit a.close").click(function(){a("splash")}),$("section.submit textarea").keyup(function(){n()}),$("section.submit .add-line").click(function(){$(".error").remove();var n=" <span class='error'>Required</span>";if(""===$("#the-line").val()&&$("label[for=the-line]").append(n),0===$(".checkbox-list input:checked").length&&$(".form-control--audience .form-control__label").append(n),0===$(".error").length)l(function(){r()});else{var t=$(".error").first();u(t)}}),$("body").on("webkitAnimationEnd oanimationend msAnimationEnd animationend",function(){$(".line-added").removeClass("fade-in")}),$(window).on("swipeleft",function(){D()}),$("section.lines a.close").click(function(){a("splash"),N(),$(".pause").removeClass("is-paused")}),$(document).on("click",".thumbs-up, .thumbs-down",function(){var n=$(this).parents(".line").attr("name"),t=$(this).hasClass("thumbs-up"),e=$(this);i(n,t,function(){e.toggleClass("active"),e.hasClass("active")&&e.siblings(".btn.active").removeClass("active")})}),$("input[type=range]").change(function(){P=$(this).val()}),$(".pause").click(function(){$(this).toggleClass("is-paused"),$(this).hasClass("is-paused")?M():A()}),$(".next").click(function(){D()})}),$("#admin-table .btn:first-child").click(function(){$(this).toggleClass("active"),$(this).hasClass("active")?$(this).text("Approved"):$(this).text("Approve")}),$("#admin-table .btn:last-child").click(function(){window.confirm("Delete this line?  This cannot be undone.")}),$("#admin-table .ban-ip").click(function(){window.confirm("Ban this IP?  This will also delete all this IP's lines, and cannot be undone.")});