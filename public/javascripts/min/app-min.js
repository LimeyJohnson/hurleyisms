$(document).ready(function(){function e(){var e=$("section.submit textarea"),n=e.attr("maxlength"),t=e.val().length,i=n-t,a=1>i;$("section.submit .char-remaining").text(i),$("section.submit label[for=the-line] .form-control__label-hint").toggleClass("error",a)}function n(e){$.getJSON("app/data/"+Q+"/"+P,function(n){L=n,e()})}function t(e,n){$.post("app/add",e,function(e){n()})}function i(e,n,t){$.getJSON("app/rate/"+e+"/"+n,function(e){t()})}function a(e){var n=$("section."+e);n.hasClass("active")||($("section.active").removeClass("active"),n.addClass("active"))}function c(){return $("body").hasClass("is-logged-in")}function o(){var e=$("section.submit");e.find("input, textarea").removeAttr("disabled"),e.find(".btn--green").removeAttr("disabled"),e.find(".switch").removeClass("disabled")}function s(){var e=$("section.submit");e.find("input, textarea").attr("disabled",!0),e.find(".btn--green").attr("disabled",!0),e.find(".switch").addClass("disabled")}function l(){return!$("body").hasClass("is-unverified-email")}function r(e){var n={};n.line=$("#the-line").val(),n.men=$("#audience-men").is(":checked"),n.women=$("#audience-women").is(":checked"),n.kids=$("#audience-kids").is(":checked"),n.profanity=$("#switch-pg").hasClass("active"),n.author=$("#your-name").val(),t(n,e)}function u(){$("#the-line").val(""),d($("body"))}function d(e){$("html, body").animate({scrollTop:e.offset().top},250)}function f(){h(),m(),T(),A()}function h(){var e;Q===R.MEN&&(e="men"),Q===R.WOMEN&&(e="women"),Q===R.KIDS&&(e="kids"),$("span.audience").text(e)}function m(){var e=p();y(e)}function p(){for(var e=v()?1:5,n=[],t=[],i=!1,a=$("main .line").first(),c=0;e>c&&c<L.length;c++){for(var o;;)if(o=b(),g(o._id,t)){t.push(o._id),n.push(o);break}if(0===a.length&&(a=_()),w(o,a),i=k(a))break;a=a.next()}return n}function v(){return window.matchMedia("(max-width: 568px)").matches}function b(){var e=Math.floor(Math.random()*L.length);return L[e]}function g(e,n){return-1===n.indexOf(e)}function _(){return $("#lines .line:last-child").clone().appendTo("#lines")}function w(e,n){n.find(".line__text").html(e.line),n.find(".line__byline .author").text(e.author),n.attr("name",e._id)}function k(e){return x(e)?(v()?C(e):e.remove(),!0):!1}function x(e){var n=e[0].getBoundingClientRect(),t=$(".lines__footer").height()+$("#progress-bar").height(),i=window.innerHeight-t;return n.bottom>i}function C(e){for(var n=e.children(".line__text").css("font-size"),t=parseInt(n,10);x(e);)t-=2,e.children(".line__text").css("font-size",t)}function y(e){Z=e.map(function(e){return e.line.length}).reduce(function(e,n){return e+n})}function T(){U=$("input[type=range]").val()}function A(){X=requestAnimationFrame(I)}function M(){cancelAnimationFrame(X),Y=null}function N(){M(),Y=null,G.width(0)}function I(e){var n=O(e);n>100&&(n=0,W());var t=n+"%";G.css("width",t),Y=e,A()}function O(e){Y||(Y=e);var n=e-Y,t=G.width()/j.width()*100,i=v()?.5:1,a=i*U*n/Z;return t+a}function W(){E(),S(),m(),d($("body"))}function E(){$(".thumbs-up.active, .thumbs-down.active").removeClass("active")}function S(){$("#lines .line__text").removeAttr("style")}function D(e){if(!F())return!1;var n=!!Y,t=$(".line__textarea");t.length&&z(),H(),V=e.html();var i=e.outerHeight();e.replaceWith("<textarea class='line__textarea' spellcheck='true' style='height: "+i+"px;'>"+V+"</textarea>"),$(".line__textarea").data("prog-bar-running",n).focus()}function F(){return $("body").hasClass("is-admin")}function K(){q();var e=$(".line__textarea");e.replaceWith("<p class='line__text'>"+e.val()+"</p>"),$.createToast("Changes saved!")}function q(){var e=$(".line__textarea").data("prog-bar-running");e&&J()}function z(){q(),$(".line__textarea").replaceWith("<p class='line__text'>"+V+"</p>")}function B(){N(),G.width(0),W(),$(".pause").hasClass("is-paused")||A()}function H(){$(".pause").addClass("is-paused"),M()}function J(){$(".pause").removeClass("is-paused"),A()}var L=[],P=!1,R={MEN:0,WOMEN:1,KIDS:2},V,j=$("#progress-bar"),G=$("#progress-bar__fill"),Q,U,X,Y,Z;e(),$("a.begin-session").click(function(){Q=Number($(this).attr("data-audience-type")),n(function(){a("lines"),f()})}),$(".switch").click(function(){$(this).toggleClass("active"),P=$(this).hasClass("active")}),$(".btn.add-line").click(function(){a("submit"),c()?o():s()}),$(document).keyup(function(e){80===e.which&&$("body").toggleClass("has-payment-error"),69===e.which&&$("body").toggleClass("is-unverified-email"),76!==e.which&&69!==e.which||(c()&&l()?o():s())}),$(".resend-verification-email").click(function(){$.createToast("Verification email sent!")}),$("section.submit a.close").click(function(){a("splash")}),$("section.submit textarea").keyup(function(){e()}),$("section.submit .add-line").click(function(){$(".error").remove();var e=" <span class='error'>Required</span>";if(""===$("#the-line").val()&&$("label[for=the-line]").append(e),0===$(".checkbox-list input:checked").length&&$(".form-control--audience .form-control__label").append(e),0===$(".error").length)r(function(){$.createToast("Line submitted!"),u()});else{var n=$(".error").first();d(n)}}),$(document).on("click",".line__text",function(){D($(this))}),$(document).keyup(function(e){65!==e.which||$(e.target).isTextField()||$("body").toggleClass("is-admin")}),$(document).on("click",".line__delete",function(){var e=$(this).closest(".line").attr("name");$("#delete-line-modal").data("line",e),H()}),$("#delete-line-modal, #delete-line-modal .modal__close, #delete-line-modal .btn--red").click(function(){J()}),$("#delete-line-modal .btn--red").click(function(){var e=$("#delete-line-modal").data("line");$.createToast("Line deleted",null,"toast--red"),$(".line[name="+e+"]").remove()}),$(document).on("keydown",".line__textarea",function(e){13===e.which&&e.metaKey&&K()}),$(document).on("click",".line__save-change",function(){K()}),$(document).on("keydown",".line__textarea",function(e){27===e.which&&z()}),$(document).on("click",".line__cancel-change",function(){z()}),$(window).on("swipeleft",function(){B()}),$("section.lines a.close").click(function(){a("splash"),N(),$(".pause").removeClass("is-paused")}),$(document).on("click",".thumbs-up, .thumbs-down",function(){var e=$(this).parents(".line").attr("name"),n=$(this).hasClass("thumbs-up"),t=$(this);i(e,n,function(){t.toggleClass("active"),t.hasClass("active")&&t.siblings(".btn.active").removeClass("active")})}),$("input[type=range]").change(function(){U=$(this).val()}),$(".pause").click(function(){$(this).hasClass("is-paused")?J():H()}),$(".next").click(function(){B()})}),$("#admin-table .btn:first-child").click(function(){$(this).toggleClass("active"),$(this).hasClass("active")?$(this).text("Approved"):$(this).text("Approve")}),$("#admin-table .btn:last-child").click(function(){window.confirm("Delete this line?  This cannot be undone.")}),$("#admin-table .ban-ip").click(function(){window.confirm("Ban this IP?  This will also delete all this IP's lines, and cannot be undone.")});