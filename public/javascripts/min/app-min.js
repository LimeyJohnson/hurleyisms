$(document).ready(function(){function n(){var n=$("section.submit textarea"),e=n.attr("maxlength"),t=n.val().length,i=e-t,a=1>i;$("section.submit .char-remaining").text(i),$("section.submit label[for=the-line] .form-control__label-hint").toggleClass("error",a)}function e(n){$.getJSON("app/data/"+U+"/"+R,function(e){P=e,n()})}function t(n,e){$.post("app/add",n,function(n){e()})}function i(n,e,t){$.getJSON("app/rate/"+n+"/"+e,function(n){t()})}function a(n){var e=$("section."+n);e.hasClass("active")||($("section.active").removeClass("active"),e.addClass("active"))}function o(){return $("body").hasClass("is-logged-in")}function s(){var n=$("section.submit");n.find("input, textarea").removeAttr("disabled"),n.find(".btn--green").removeAttr("disabled"),n.find(".switch").removeClass("disabled")}function c(){var n=$("section.submit");n.find("input, textarea").attr("disabled",!0),n.find(".btn--green").attr("disabled",!0),n.find(".switch").addClass("disabled")}function l(n){var e={};e.line=$("#the-line").val(),e.men=$("#audience-men").is(":checked"),e.women=$("#audience-women").is(":checked"),e.kids=$("#audience-kids").is(":checked"),e.profanity=$("#switch-pg").hasClass("active"),e.author=$("#your-name").val(),t(e,n)}function r(){$(".line-added").addClass("fade-in"),$("#the-line").val(""),u($("body"))}function u(n){$("html, body").animate({scrollTop:n.offset().top},250)}function d(){f(),h(),y(),A()}function f(){var n;U===j.MEN&&(n="men"),U===j.WOMEN&&(n="women"),U===j.KIDS&&(n="kids"),$("span.audience").text(n)}function h(){var n=m();C(n)}function m(){for(var n=p()?1:5,e=[],t=[],i=!1,a=$("main .line").first(),o=0;n>o&&o<P.length;o++){for(var s;;)if(s=v(),b(s._id,t)){t.push(s._id),e.push(s);break}if(0===a.length&&(a=g()),_(s,a),i=x(a))break;a=a.next()}return e}function p(){return window.matchMedia("(max-width: 568px)").matches}function v(){var n=Math.floor(Math.random()*P.length);return P[n]}function b(n,e){return-1===e.indexOf(n)}function g(){return $("#lines .line:last-child").clone().appendTo("#lines")}function _(n,e){e.find(".line__text").html(n.line),e.find(".line__byline .author").text(n.author),e.attr("name",n._id)}function x(n){return k(n)?(p()?w(n):n.remove(),!0):!1}function k(n){var e=n[0].getBoundingClientRect(),t=$(".lines__footer").height()+$("#progress-bar").height(),i=window.innerHeight-t;return e.bottom>i}function w(n){for(var e=n.children(".line__text").css("font-size"),t=parseInt(e,10);k(n);)t-=2,n.children(".line__text").css("font-size",t)}function C(n){Z=n.map(function(n){return n.line.length}).reduce(function(n,e){return n+e})}function y(){V=$("input[type=range]").val()}function A(){X=requestAnimationFrame(E)}function M(){cancelAnimationFrame(X),Y=null}function N(){M(),Y=null,Q.width(0)}function E(n){var e=I(n);e>100&&(e=0,O());var t=e+"%";Q.css("width",t),Y=n,A()}function I(n){Y||(Y=n);var e=n-Y,t=Q.width()/L.width()*100,i=p()?.5:1,a=i*V*e/Z;return t+a}function O(){W(),S(),h(),u($("body"))}function W(){$(".thumbs-up.active, .thumbs-down.active").removeClass("active")}function S(){$("#lines .line__text").removeAttr("style")}function T(n){if(!D())return!1;var e=!!Y,t=$(".line__textarea");t.length&&B(),H(),G=n.html();var i=n.outerHeight();n.replaceWith("<textarea class='line__textarea' spellcheck='true' style='height: "+i+"px;'>"+G+"</textarea>"),$(".line__textarea").data("prog-bar-running",e).focus()}function D(){return $("body").hasClass("is-admin")}function K(n){return $(n).is("textarea")}function q(){z();var n=$(".line__textarea");n.replaceWith("<p class='line__text'>"+n.val()+"</p>")}function z(){var n=$(".line__textarea").data("prog-bar-running");n&&J()}function B(){z(),$(".line__textarea").replaceWith("<p class='line__text'>"+G+"</p>")}function F(){N(),Q.width(0),O(),$(".pause").hasClass("is-paused")||A()}function H(){$(".pause").addClass("is-paused"),M()}function J(){$(".pause").removeClass("is-paused"),A()}var P=[],R=!1,j={MEN:0,WOMEN:1,KIDS:2},G,L=$("#progress-bar"),Q=$("#progress-bar__fill"),U,V,X,Y,Z;n(),$("a.begin-session").click(function(){U=Number($(this).attr("data-audience-type")),e(function(){a("lines"),d()})}),$(".switch").click(function(){$(this).toggleClass("active"),R=$(this).hasClass("active")}),$(".btn.add-line").click(function(){a("submit"),o()?s():c()}),$(document).keyup(function(n){76===n.keyCode&&(o()?s():c())}),$("section.submit a.close").click(function(){a("splash")}),$("section.submit textarea").keyup(function(){n()}),$("section.submit .add-line").click(function(){$(".error").remove();var n=" <span class='error'>Required</span>";if(""===$("#the-line").val()&&$("label[for=the-line]").append(n),0===$(".checkbox-list input:checked").length&&$(".form-control--audience .form-control__label").append(n),0===$(".error").length)l(function(){r()});else{var e=$(".error").first();u(e)}}),$("body").on("webkitAnimationEnd oanimationend msAnimationEnd animationend",function(){$(".line-added").removeClass("fade-in")}),$(document).on("click",".line__text",function(){T($(this))}),$(document).keyup(function(n){65!==n.which||K(n.target)||$("body").toggleClass("is-admin")}),$(document).on("keydown",".line__textarea",function(n){13===n.which&&n.metaKey&&q()}),$(document).on("click",".line__save-change",function(){q()}),$(document).on("keydown",".line__textarea",function(n){27===n.which&&B()}),$(document).on("click",".line__cancel-change",function(){B()}),$(window).on("swipeleft",function(){F()}),$("section.lines a.close").click(function(){a("splash"),N(),$(".pause").removeClass("is-paused")}),$(document).on("click",".thumbs-up, .thumbs-down",function(){var n=$(this).parents(".line").attr("name"),e=$(this).hasClass("thumbs-up"),t=$(this);i(n,e,function(){t.toggleClass("active"),t.hasClass("active")&&t.siblings(".btn.active").removeClass("active")})}),$("input[type=range]").change(function(){V=$(this).val()}),$(".pause").click(function(){$(this).hasClass("is-paused")?J():H()}),$(".next").click(function(){F()})}),$("#admin-table .btn:first-child").click(function(){$(this).toggleClass("active"),$(this).hasClass("active")?$(this).text("Approved"):$(this).text("Approve")}),$("#admin-table .btn:last-child").click(function(){window.confirm("Delete this line?  This cannot be undone.")}),$("#admin-table .ban-ip").click(function(){window.confirm("Ban this IP?  This will also delete all this IP's lines, and cannot be undone.")});