$(document).ready(function(){function n(){var n=$("section.submit textarea"),e=n.attr("maxlength"),t=n.val().length,i=e-t,a=1>i;$("section.submit .char-remaining").text(i),$("section.submit label[for=the-line] .form-control__label-hint").toggleClass("error",a)}function e(n){$.getJSON("app/data/"+Q+"/"+P,function(e){J=e,n()})}function t(n,e){$.post("app/add",n,function(n){e()})}function i(n,e,t){$.getJSON("app/rate/"+n+"/"+e,function(n){t()})}function a(n){var e=$("section."+n);e.hasClass("active")||($("section.active").removeClass("active"),e.addClass("active"))}function s(){return $("body").hasClass("is-logged-in")}function o(){var n=$("section.submit");n.find("input, textarea").removeAttr("disabled"),n.find(".btn--green").removeAttr("disabled"),n.find(".switch").removeClass("disabled")}function c(){var n=$("section.submit");n.find("input, textarea").attr("disabled",!0),n.find(".btn--green").attr("disabled",!0),n.find(".switch").addClass("disabled")}function l(n){var e={};e.line=$("#the-line").val(),e.men=$("#audience-men").is(":checked"),e.women=$("#audience-women").is(":checked"),e.kids=$("#audience-kids").is(":checked"),e.profanity=$("#switch-pg").hasClass("active"),e.author=$("#your-name").val(),t(e,n)}function r(){$(".line-added").addClass("fade-in"),$("#the-line").val(""),u($("body"))}function u(n){$("html, body").animate({scrollTop:n.offset().top},250)}function d(){f(),h(),y(),A()}function f(){var n;Q===R.MEN&&(n="men"),Q===R.WOMEN&&(n="women"),Q===R.KIDS&&(n="kids"),$("span.audience").text(n)}function h(){var n=m();C(n)}function m(){for(var n=p()?1:5,e=[],t=[],i=!1,a=$("main .line").first(),s=0;n>s&&s<J.length;s++){for(var o;;)if(o=v(),b(o._id,t)){t.push(o._id),e.push(o);break}if(0===a.length&&(a=g()),_(o,a),i=x(a))break;a=a.next()}return e}function p(){return window.matchMedia("(max-width: 568px)").matches}function v(){var n=Math.floor(Math.random()*J.length);return J[n]}function b(n,e){return-1===e.indexOf(n)}function g(){return $("#lines .line:last-child").clone().appendTo("#lines")}function _(n,e){e.find(".line__text").html(n.line),e.find(".line__byline .author").text(n.author),e.attr("name",n._id)}function x(n){return k(n)?(p()?w(n):n.remove(),!0):!1}function k(n){var e=n[0].getBoundingClientRect(),t=$(".lines__footer").height()+$("#progress-bar").height(),i=window.innerHeight-t;return e.bottom>i}function w(n){for(var e=n.children(".line__text").css("font-size"),t=parseInt(e,10);k(n);)t-=2,n.children(".line__text").css("font-size",t)}function C(n){Y=n.map(function(n){return n.line.length}).reduce(function(n,e){return n+e})}function y(){U=$("input[type=range]").val()}function A(){V=requestAnimationFrame(E)}function M(){cancelAnimationFrame(V),X=null}function N(){M(),X=null,L.width(0)}function E(n){var e=I(n);e>100&&(e=0,O());var t=e+"%";L.css("width",t),X=n,A()}function I(n){X||(X=n);var e=n-X,t=L.width()/G.width()*100,i=p()?.5:1,a=i*U*e/Y;return t+a}function O(){T(),W(),h(),u($("body"))}function T(){$(".thumbs-up.active, .thumbs-down.active").removeClass("active")}function W(){$("#lines .line__text").removeAttr("style")}function S(n){if(!D())return!1;var e=!!X,t=$(".line__textarea");t.length&&q(),B(),j=n.html();var i=n.outerHeight();n.replaceWith("<textarea class='line__textarea' spellcheck='true' style='height: "+i+"px;'>"+j+"</textarea>"),$(".line__textarea").data("prog-bar-running",e).focus()}function D(){return $("body").hasClass("is-admin")}function F(){K();var n=$(".line__textarea");n.replaceWith("<p class='line__text'>"+n.val()+"</p>")}function K(){var n=$(".line__textarea").data("prog-bar-running");n&&H()}function q(){K(),$(".line__textarea").replaceWith("<p class='line__text'>"+j+"</p>")}function z(){N(),L.width(0),O(),$(".pause").hasClass("is-paused")||A()}function B(){$(".pause").addClass("is-paused"),M()}function H(){$(".pause").removeClass("is-paused"),A()}var J=[],P=!1,R={MEN:0,WOMEN:1,KIDS:2},j,G=$("#progress-bar"),L=$("#progress-bar__fill"),Q,U,V,X,Y;n(),$("a.begin-session").click(function(){Q=Number($(this).attr("data-audience-type")),e(function(){a("lines"),d()})}),$(".switch").click(function(){$(this).toggleClass("active"),P=$(this).hasClass("active")}),$(".btn.add-line").click(function(){a("submit"),s()?o():c()}),$(document).keyup(function(n){76===n.keyCode&&(s()?o():c())}),$("section.submit a.close").click(function(){a("splash")}),$("section.submit textarea").keyup(function(){n()}),$("section.submit .add-line").click(function(){$(".error").remove();var n=" <span class='error'>Required</span>";if(""===$("#the-line").val()&&$("label[for=the-line]").append(n),0===$(".checkbox-list input:checked").length&&$(".form-control--audience .form-control__label").append(n),0===$(".error").length)l(function(){r()});else{var e=$(".error").first();u(e)}}),$("body").on("webkitAnimationEnd oanimationend msAnimationEnd animationend",function(){$(".line-added").removeClass("fade-in")}),$(document).on("click",".line__text",function(){S($(this))}),$(document).keyup(function(n){65!==n.which||$(n.target).isTextField()||$("body").toggleClass("is-admin")}),$(document).on("keydown",".line__textarea",function(n){13===n.which&&n.metaKey&&F()}),$(document).on("click",".line__save-change",function(){F()}),$(document).on("keydown",".line__textarea",function(n){27===n.which&&q()}),$(document).on("click",".line__cancel-change",function(){q()}),$(window).on("swipeleft",function(){z()}),$("section.lines a.close").click(function(){a("splash"),N(),$(".pause").removeClass("is-paused")}),$(document).on("click",".thumbs-up, .thumbs-down",function(){var n=$(this).parents(".line").attr("name"),e=$(this).hasClass("thumbs-up"),t=$(this);i(n,e,function(){t.toggleClass("active"),t.hasClass("active")&&t.siblings(".btn.active").removeClass("active")})}),$("input[type=range]").change(function(){U=$(this).val()}),$(".pause").click(function(){$(this).hasClass("is-paused")?H():B()}),$(".next").click(function(){z()})}),$("#admin-table .btn:first-child").click(function(){$(this).toggleClass("active"),$(this).hasClass("active")?$(this).text("Approved"):$(this).text("Approve")}),$("#admin-table .btn:last-child").click(function(){window.confirm("Delete this line?  This cannot be undone.")}),$("#admin-table .ban-ip").click(function(){window.confirm("Ban this IP?  This will also delete all this IP's lines, and cannot be undone.")});